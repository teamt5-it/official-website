<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TeamT5 - Persistent Cyber Threat Hunters</title>
  <meta
    name="description"
    content="TeamT5 is a group of hackers dedicated on cyber threat research. The team started with their outstanding research and has been delivering their cyber threat intelligence (CTI) for more than 5 years."
  />
  <meta
    name="keywords"
    content="TeamT5, ThreatSonar, ThreatVision, cyber espionage, TT, Cyber Threat Hunters, cyber espionage solutions, threat analysis service, incident response, investigation services, threat intelligence, Elegant Threat Hunting Technology"
  />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    property="og:title"
    content="TeamT5 - Persistent Cyber Threat Hunters"
  />
  <meta
    property="og:description"
    content="TeamT5 is a group of hackers dedicated on cyber threat research. The team started with their outstanding research and has been delivering their cyber threat intelligence (CTI) for more than 5 years."
  />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="/assets/images/og-image.jpg" />
  <link
    href="https://fonts.googleapis.com/css?family=Noto+Sans+TC:400,500,700&display=swap&subset=chinese-traditional"
    rel="stylesheet"
  />
  <link rel="icon" type="image/icon" href="/assets/images/favicon.ico" />
  <link rel="stylesheet" type="text/css" href="/assets/main-7383437ebdec817d69f1db11a083c62e3d6f5c775a35fc8ee18b88c67dc2c866.css" integrity="sha256-c4NDfr3sgX1p8dsRoIPGLj1vXHdaNfyO4YuIxn3CyGY=" crossorigin="anonymous"> <script integrity="sha256-ZXwkbee/Uwspyw5FDzhhG6YQBtn5LFRLCRt2xMtBSIk=" crossorigin="anonymous" src="/assets/main-657c246de7bf530b29cb0e450f38611ba61006d9f92c544b091b76c4cb414889.js" type="text/javascript"></script>
</head>


<body>
  <div class="header-container">
    <header class="navbar">
    <div class="navbar-brand-and-menu">

        <div class="navbar-brand">
            <a class="navbar-brand-logo" href="/">
                <object data="/assets/header/header-logo-3b363715bccbf56e1d1f26d37b954be04245a4e6bf74e4e5dc466c8fc624aa6b.svg">
                </object>
            </a>
            <div class="navbar-burger">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </div>
        </div>
        <div class="navbar-menu">
            <div class="navbar-item navbar-item-has-submenu">
                <div class="navbar-item-link
            
                
            ">
                    <div class="navbar-item-title title">
                        Products
                    </div>
                    <div class="navbar-item-arrow">
                        <object data="/assets/arrow-down-grey-color-c386e3d166125119750898fef68303e4aeafc8670b11bccdd778363c6e02f8b9.svg">
                        </object>
                    </div>
                </div>
                <div class="navbar-submenu">
                    <a class="navbar-submenu-item-link" href="/products/threatsonar/">
                        <div class="navbar-submenu-item title">
                            ThreatSonar
                        </div>
                    </a>
                    <a class="navbar-submenu-item-link" href="/products/threatvision/">
                        <div class="navbar-submenu-item title">
                            ThreatVision
                        </div>
                    </a>
                </div>
            </div>
            <div class="navbar-item">
                <a class="navbar-item-link
            
            " href="/partners/">
                    <div class="navbar-item-title title">
                        Partners
                    </div>
                </a>
            </div>
            <div class="navbar-item">
                <a class="navbar-item-link
            
            " href="/blog/">
                    <div class="navbar-item-title title">
                        Blog
                    </div>
                </a>
            </div>
            <div class="navbar-item navbar-item-has-submenu">
                <div class="navbar-item-link

            
                
            ">
                    <div class="navbar-item-title title">
                        Company</div>
                    <div class="navbar-item-arrow">
                        <object data="/assets/arrow-down-grey-color-c386e3d166125119750898fef68303e4aeafc8670b11bccdd778363c6e02f8b9.svg">
                        </object>
                    </div>
                </div>
                <div class="navbar-submenu">
                    <a class="navbar-submenu-item-link" href="/about-us/">
                        <div class="navbar-submenu-item title">
                            About us
                        </div>
                    </a>
                    <a class="navbar-submenu-item-link" href="/contact-us/">
                        <div class="navbar-submenu-item title">
                            Contact us
                        </div>
                    </a>
                    <a class="navbar-submenu-item-link" href="/careers/">
                        <div class="navbar-submenu-item title">
                            Careers
                        </div>
                    </a>
                    <a class="navbar-submenu-item-link" href="/newsroom/">
                        <div class="navbar-submenu-item title">
                            Newsroom
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="navbar-submenu-padding">
        <div class="navbar-submenu-padding-box">

        </div>
    </div>
</header>

  </div>
  <div class="main-container">
    <div class="post-page-title-container">
    <div class="post-page-title">
        <div class="post-page-title-content title title-leftline ">
            BlackHat’s Talk: Breaking Samsung’s Root of Trust - Exploiting Samsung Secure Boot
        </div>
    </div>
</div>

<main class="post-layout">
    <div class="post-meta">
        
        <div class="post-date date">
            2020/06/10
        </div>
    </div>
    <div class="post-banner">
        <img class="lazy" data-src="/assets/images/20200608_cover.jpg">
    </div>
    <div class="post-content content">
        <h3 id="d39">D39</h3>

<p>D39 focuses on vulnerability research and has identified several critical security flaws, including technical exploitation of mobile, IoT devices, and Linux and Windows operating systems. We have reported dozens of vulnerabilities and dedicate to Samsung Vulnerabilities and Exposures (SVE) and Common Vulnerabilities and Exposures (CVE).</p>

<p>Before diving into the main subject this month, we are glad to announce that TeamT5 is again accepted at Black Hat USA, and our vulnerability research team, D39, will talk at the Black Hat Briefings in the upcoming August. We are honored to share our research findings with researchers and security experts all over the world and expect more recognition of Taiwan’s vulnerability researchers in the world.</p>

<p><img src="/assets/images/d39_6-1.png" alt="" />
<a href="https://www.blackhat.com/us-20/briefings/schedule/index.html#breaking-samsungs-root-of-trust-exploiting-samsung-s-secure-boot-20290">Black Hat Session</a></p>

<p>This article will cover a part of our talk at Black Hat USA in August.</p>

<h3 id="introduction">Introduction</h3>

<p>We have found several vulnerabilities in Samsung Secure boot, which can break through Samsung Knox protections. We can even retrieve users’ sensitive data from a locked device. The affected Samsung mobiles include Galaxy S8, S9, and S10. Patches to these vulnerabilities have been provided by Samsung.</p>

<p>One of these vulnerabilities allows attackers to execute arbitrary code in Galaxy S8 secure bootloader to access the device. In this article, we will elaborate how we exploit these vulnerabilities to bypass S8 secure bootloader through the USB device and obtain arbitrary code execution in early boot stage.</p>

<p>Note: Another security research team found this vulnerability at the same time and report it to Samsung.
ID: SVE-2019-15230 (details below).
<img src="/assets/images/sve-2019.png" alt="" /></p>

<h3 id="knox">KNOX</h3>

<p><img src="/assets/images/d39_6-2.png" alt="" />
<a href="https://docs.samsungknox.com/whitepapers/knox-platform/hardware-backed-root-of-trust.htm">Image courtesy</a></p>

<p>As the market leader of smartphone, Samsung conducts a series of protection on Android, known as the Knox Platform, to ensure the security of its devices. During the booting process, Samsung uses S-boot (Secure Boot) to make sure it can only boot a stocked image. If the device tries to boot a custom image, it will trip (turned from 0X0 to 0X1) a one-time programmable bit e-fuse (a.k.a Knox bit). Once a trustzone app (trustlet) detects the Knox bit tripped, it will delete the encryption key of sensitive data to prevent unauthorized data from accessing the locked device.</p>

<h3 id="vulnerability">Vulnerability</h3>

<p>Smartphones with Samsung Exynos processor use a exclusive secure bootloader named S-boot. S-boot has ODIN mode which allows users to upgrade the firmware manually. Due to the insufficiency in its code, the flash command (opcode: 0x66) in ODIN mode is not able to properly check the flash image size, which leads to buffer overflow.</p>

<p>The flash command in ODIN mode uses a temporary buffer to store the image. In Galaxy S8, the buffer is located at 0xC0000000, right in front of sboot code segment (0xC9000000). Although the system will check to ensure that the size being no larger than 0x1e0000, it uses signed comparison to check the size of the image; thus provide us some space to get around. We therefore provide a size larger than 0x80000000, making buffer overflowed and, in the end, the following segments such as code, stack, and heap will be overwritten.</p>

<p><img src="/assets/images/d39_6-3.png" alt="" /></p>

<h3 id="the-exploit">The Exploit</h3>

<h4 id="code-execution">Code Execution</h4>

<p>Although we can overflow the code segment of S-Boot, we still cannot hijack the execution flow. Since USB receivers use physical memory to hold the data it received directly, we cannot affect instruction cache unless the cache line has been invalidated.</p>

<p>Fortunately, the heap segment is not cached due to MMU flag. There are some pointers stored in the heap segment, which can be accessed during the USB process. If we overwrite these pointers with null bytes, the processor will trigger an exception and trap into the exception handler while accessing to NULL pointers. Since the handler has never been executed, it is not cached in the instruction cache. Therefore we can also overwrite the exception handler simultaneously and hijack it directly to our shellcode.</p>

<p><img src="/assets/images/d39_6-4.png" alt="" /></p>

<h4 id="booting-custom-kernel">Booting Custom Kernel</h4>

<p>Since all the run-time data has been overwritten – including stack, heap and global variables – the sboot fail to perform further booting operation. These kinds of data are difficult to recover, so we must re-execute the booting process.</p>

<p>Under normal condition, S-boot calls several functions in a particular function table which is located at 0xC90C7350. To re-execute s-boot, these functions have to be invoked sequentially again. They would initialize the memory of heap and stack, set the global variables, and boot the kernel at the end. However, these functions also involve some SMC calls which cannot be executed twice. Since we only compromised EL1 (Exception Level 1), the trustzone in EL3 (Exception Level 3) cannot be reverted. As a result, we have to overwrite these SMC calls with NOP instruction while overflowing the code segment to ignore those SMC (System Management Controller) calls.</p>

<p>After all the run-time data has been reset, we replace the original kernel with our custom one. Then we execute one last function to boot our custom kernel and get the <strong>root privilege without blowing KNOX bit</strong>.</p>

<p><img src="/assets/images/d39_6-5.png" alt="" /></p>

<h3 id="timeline">Timeline</h3>

<p>2019-10-02 Report Vulnerability<br />
2019-10-08 Informed Vulnerability duplicated and release patch note</p>

<h3 id="appendix-potential-exploit-path-on-galaxy-s10">Appendix: Potential Exploit Path on Galaxy S10</h3>

<p>According to our analysis, this vulnerability affects Galaxy S9, Galaxy S10 and Galaxy Note 10 as well. Among them we find that exploitation can still be trigger at different address. For instance, even the temporary buffer located at different addresss, like 0x890000000 in Galaxy S10, there are still chances to exploit it. To explain the complete exploitation flow, we choose the firmware, G970FXXU1ASD5, as an example.</p>

<p>In Galaxy S9 and later version, there is another feature added to the secure boot - compressed_download. It uses another buffer to store the flash image. However if compressed_download failed during the initialization, it will fallback to normal download, and use the buffer (0xC0000000) to store the flash image.</p>

<p><img src="/assets/images/d39_6-6.png" alt="" /></p>

<p>To make S-boot fallback to normal download, we have to make the function <code class="highlighter-rouge">cd_v3_smp_register</code> fail. After reversing, we noticed that the function <code class="highlighter-rouge">cd_v3_smp_register</code> may return failed if there is no available core(<code class="highlighter-rouge">booted_cores</code> &gt; 3) can be booted. Coincidentally, there is a test command - “smp_boot_test” in the UART (Universal Asynchronous Receiver/Transmitter) console. The command smp_boot_test will boot a core and add the count of the booted_cores. Although <code class="highlighter-rouge">smp_boot_test</code> shutdown the booted up core immediately, it didn’t restore the count. Therefore, the compressed_download_init may failed if the command <code class="highlighter-rouge">smp_boot_test</code> has been invoked more than twice before entering the download mode.</p>

<p>If we have the UART debug cable to get the UART console, we can call the command<code class="highlighter-rouge">smp_boot_test</code> 3 times and enter the download mode via the command <code class="highlighter-rouge">usb</code>. The <code class="highlighter-rouge">compressed_download_init</code> would fail, then the temporary buffer fallback to 0xC0000000. Therefore the arbitrary code execution on S10’s bootloader can be achieved as the one in Galaxy S8.</p>

<p>We managed to build our own TypeC debug cable at first. However, after trying every kinds of Pull-up/down resistor value, TypeC accessory mode, TypeC VDM, we cannot yet figure out a cable for RID_523K detection. Still, in the end, we applied other approach that enable us to attain <strong>Galaxy S10 Secure Bootloader’s permission of arbitrary code</strong> without having debug cable.</p>

<p>We will have a thorough display on Black Hat. Stay tuned!</p>

<p>For the latest vulnerability research from D39, please follow:</p>

<p>TeamT5 official website: <a href="https://teamt5.org/" title="https://teamt5.org/">https://teamt5.org/</a></p>

<p>Twitter: <a href="https://twitter.com/TeamT5_Official" title="https://twitter.com/TeamT5_Official">https://twitter.com/TeamT5_Official</a></p>

    </div>
    
        
    
    <a class="back-button button">
        Back
    </a>
</main>

  </div>
  <div class="footer-container">
    <footer class="footer">
    <div class="footer-logo-and-menu">
        <a class="footer-logo" href="/">
            <object data="/assets/footer/footer-logo-7feae84ff8f4616ae82197cdcb4b63d2af93c4d247b9106328f14c734e270d62.svg">
            </object>
        </a>
        <div class="footer-menu">
            <div class="footer-item">
                <div class="footer-item-title">Products</div>
                <a class="footer-item-link" href="/products/threatsonar/">ThreatSonar</a>
                <a class="footer-item-link" href="/products/threatvision/">ThreatVision</a>

            </div>
            <div class="footer-item">
                <a class="footer-item-title footer-item-link" href="/partners/">Partners</a>
                <a class="footer-item-title footer-item-link" href="/blog/">Blog</a>
            </div>
            <div class="footer-item">
                <div class="footer-item-title">Company</div>
                <a class="footer-item-link" href="/about-us/">About us</a>
                <a class="footer-item-link"
                    href="/contact-us/">Contact us</a>
                <a class="footer-item-link" href="/careers/">Careers</a>
                <a class="footer-item-link" href="/newsroom/">Newsroom</a>
            </div>
        </div>
    </div>
    <hr class="footer-hr">
    <div class="footer-informations-and-language-selector">
        <div class="footer-informations">
            <div class="footer-copyright">
                © 2019 Team T5, Inc. (Doppler Cyber Threat Solutions Inc.) All Rights Reserved.
            </div>
            <div class="footer-privacy-and-cookies-policy">
                <a href="/privacy-and-cookies-policy/">Privacy & Cookies Policy</a>
            </div>
            <div class="footer-terms-of-service">
                <a href="/terms-of-service/">Terms of Service</a>
            </div>
        </div>
        <select class="footer-language-selector" id="language-selector">
            <option value="en">English</option>
            <option value="zh">中文</option>
        </select>
    </div>
    <div class="scroll-top">
        <div class="scroll-top-square rotate-clockwise-45">
            <div class="scroll-top-content rotate-counterwise-45">
                <object class="scroll-top-arrow" data="/assets/arrow-up-78bf1dbc7f5b78b1750c58ebad959a4caea323d635c30863521203c878f2ab97.svg">
                </object>
                <div class="scroll-top-text">
                    TOP
                </div>
            </div>
        </div>
    </div>
</footer>

  </div>
</body>

</html>
